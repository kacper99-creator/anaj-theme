{% comment %}
  Sekcja: ANAJ – Pasek ogłoszeń z rotacją komunikatów (fade in/out)
{% endcomment %}

<section
  id="anaj-announcement-{{ section.id }}"
  class="anaj-ab"
  role="region"
  aria-label="{{ section.settings.aria_label | escape | default: 'Informacje sklepu' }}"
>
  <div class="anaj-ab__inner anaj-ab__inner--{{ section.settings.align }}">
    <div class="anaj-ab__slot" data-ab-rotator>
      {% for block in section.blocks %}
        {% assign text = block.settings.text %}
        {% if text != blank %}
          <div
            class="anaj-ab__item{% if forloop.first %} is-active{% endif %}"
            data-index="{{ forloop.index0 }}"
            {{ block.shopify_attributes }}
          >
            {{ text }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<style>
  #anaj-announcement-{{ section.id }}.anaj-ab{
    box-sizing:border-box;
    width:100%;
    background:#19B2FF; /* ten sam kolor co wcześniej */
    color:#fff;
    font-family:var(--font-body-family, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
    font-size:clamp(13px,1.25vw,16px);
    font-weight:700;
    line-height:1.25;
    padding:10px 16px;
    min-height:42px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    z-index:30;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__inner{
    width:100%;
    max-width:none;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__inner--left{
    justify-content:flex-start;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__slot{
    position:relative;
    width:100%;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__item{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding-inline:4px;
    text-align:center;
    opacity:0;
    transform:translateY(8px);
    pointer-events:none;
    transition:
      opacity .32s ease-out,
      transform .32s ease-out;
    white-space:normal;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__inner--left .anaj-ab__item{
    justify-content:flex-start;
    text-align:left;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__item.is-active{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }

  #anaj-announcement-{{ section.id }} .anaj-ab__item strong{
    color:#FFD700;
    font-weight:800;
    letter-spacing:-0.1px;
  }

  @media (max-width: 768px){
    #anaj-announcement-{{ section.id }}{
      padding-inline:10px;
      font-size:13px;
      line-height:1.35;
    }
  }

  @media (prefers-reduced-motion: reduce){
    #anaj-announcement-{{ section.id }} .anaj-ab__item{
      transition:none !important;
    }
  }
</style>

<script>
(function(){
  const root = document.getElementById('anaj-announcement-{{ section.id }}');
  if (!root) return;

  const slot  = root.querySelector('[data-ab-rotator]');
  if (!slot) return;

  const items = slot.querySelectorAll('.anaj-ab__item');
  if (!items.length) return;

  // Jeżeli jest tylko jeden komunikat – pokaż go bez rotacji
  if (items.length === 1){
    items[0].classList.add('is-active');
    return;
  }

  const mq = window.matchMedia('(max-width: 768px)');

  const intervalDesktopSeconds = {{ section.settings.interval_desktop | default: 8 }};
  const intervalMobileSeconds  = {{ section.settings.interval_mobile  | default: 10 }};

  function getIntervalMs(){
    return (mq.matches ? intervalMobileSeconds : intervalDesktopSeconds) * 1000;
  }

  let current = 0;
  let timer   = null;

  function show(index){
    items.forEach((el, i) => {
      if (i === index){
        el.classList.add('is-active');
      } else {
        el.classList.remove('is-active');
      }
    });
  }

  function next(){
    current = (current + 1) % items.length;
    show(current);
  }

  function start(){
    if (timer) clearInterval(timer);
    show(current);
    timer = setInterval(next, getIntervalMs());
  }

  // Restart przy zmianie rozmiaru / trybu mobile/desktop
  mq.addEventListener ? mq.addEventListener('change', start) :
    mq.addListener && mq.addListener(start);

  window.addEventListener('pageshow', function(e){
    if (e.persisted) start();
  });

  start();
})();
</script>

{% schema %}
{
  "name": "ANAJ – Pasek ogłoszeń (rotacja)",
  "settings": [
    {
      "type": "text",
      "id": "aria_label",
      "label": "Opis dla czytników ekranu",
      "default": "Informacje sklepu"
    },
    {
      "type": "select",
      "id": "align",
      "label": "Wyrównanie tekstu",
      "options": [
        { "value": "center", "label": "Wyśrodkowany" },
        { "value": "left",   "label": "Do lewej" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "interval_desktop",
      "label": "Czas wyświetlania na desktopie (sekundy)",
      "min": 3,
      "max": 20,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "interval_mobile",
      "label": "Czas wyświetlania na mobile (sekundy)",
      "min": 3,
      "max": 25,
      "step": 1,
      "default": 10
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Komunikat",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Tekst komunikatu",
          "default": "<p>+10&nbsp;000 zadowolonych klientów</p>"
        }
      ]
    }
  ],
  "max_blocks": 8,
  "presets": [
    {
      "name": "ANAJ – Pasek ogłoszeń (rotacja)",
      "category": "Nagłówek",
      "blocks": [
        {
          "type": "message",
          "settings": {
            "text": "<p>+10&nbsp;000 zadowolonych klientów</p>"
          }
        },
        {
          "type": "message",
          "settings": {
            "text": "<p>Darmowa dostawa od 100&nbsp;zł</p>"
          }
        },
        {
          "type": "message",
          "settings": {
            "text": "<p>Z kodem: <strong>Simply7</strong> — 7% taniej</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
