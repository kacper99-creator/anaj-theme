{% assign slider_id = 'anaj-image-slider-' | append: section.id %}

{% if section.blocks.size > 0 %}
<div id="{{ slider_id }}" class="anaj-slider anaj-image-slider" role="region" aria-label="ANAJ – slider banerowy z hotspotem">
  <div class="track">
    {% for block in section.blocks %}
      {% assign bg_image  = block.settings.image | image_url: width: 2000 %}
      {% assign cta_href  = block.settings.cta_link %}
      {% assign cta_label = block.settings.cta_label | default: 'Zamów teraz' %}
      {% assign cta_x     = block.settings.cta_x | default: 50 %}
      {% assign cta_y     = block.settings.cta_y | default: 80 %}

      <div class="slide{% if forloop.first %} is-active{% endif %}" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
        {% if bg_image != blank %}
          <div class="media" style="--bg:url('{{ bg_image }}');"></div>
        {% endif %}

        {% if cta_href != blank and cta_label != blank %}
          <a class="hero-cta"
             href="{{ cta_href }}"
             aria-label="{{ cta_label | escape }}"
             style="--cta-x: {{ cta_x }}%; --cta-y: {{ cta_y }}%;">
            {{ cta_label }}
            <svg class="hero-cta__icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41L13.17 12z"/>
            </svg>
          </a>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <button class="nav prev" aria-label="Poprzedni slajd">‹</button>
  <button class="nav next" aria-label="Następny slajd">›</button>

  <div class="dots" role="tablist" aria-label="Paginacja slajdów">
    {% for block in section.blocks %}
      <button class="dot{% if forloop.first %} is-active{% endif %}"
              data-index="{{ forloop.index0 }}"
              role="tab"
              aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"></button>
    {% endfor %}
  </div>
</div>
{% endif %}

<style>
#{{ slider_id }}{
  position:relative;
  overflow:hidden;
  width:100%;
}

#{{ slider_id }} .track{
  display:grid;
  position:relative;
}

#{{ slider_id }} .slide{
  grid-area:1/1;
  position:relative;
  opacity:0;
  z-index:0;
  pointer-events:none;
  transition:opacity .6s ease;
  width:100%;
  aspect-ratio:16 / 9; /* stała proporcja 16:9 */
  overflow:hidden;
}

#{{ slider_id }} .slide.is-active{
  opacity:1;
  pointer-events:auto;
  z-index:1;
}

#{{ slider_id }} .media{
  position:absolute;
  inset:0;
  background:var(--bg) center 50% / cover no-repeat;
  will-change:transform;
}

#{{ slider_id }} .slide.is-active .media{
  animation:kb 6.5s ease-out both;
}

@keyframes kb{
  0%   { transform:scale(1.02) translate3d(0,-0.5%,0); }
  100% { transform:scale(1.06) translate3d(0,-2%,0); }
}

/* TYLKO PRZYCISK JEST KLIKALNY – POZYCJA X/Y W % */
#{{ slider_id }} .hero-cta{
  position:absolute;
  left:var(--cta-x);
  top:var(--cta-y);
  transform:translate(-50%, -50%);
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:12px 18px;
  border-radius:999px;
  font-weight:800;
  font-size:15px;
  line-height:1;
  color:#2f271f;
  background:linear-gradient(#fff7e6,#ecd6ad);
  border:1px solid rgba(0,0,0,.15);
  box-shadow:0 1px 0 rgba(255,255,255,.75) inset, 0 8px 20px rgba(0,0,0,.18);
  text-decoration:none;
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
}

#{{ slider_id }} .hero-cta:hover{
  transform:translate(-50%, -50%) translateY(-1px);
  box-shadow:0 10px 24px rgba(0,0,0,.22);
}

#{{ slider_id }} .hero-cta__icon{
  flex:0 0 auto;
}

#{{ slider_id }} .nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:44px;
  height:44px;
  border-radius:999px;
  background:rgba(255,255,255,.24);
  border:1px solid rgba(255,255,255,.6);
  backdrop-filter:blur(6px);
  box-shadow:0 8px 24px rgba(0,0,0,.18);
  z-index:5;
}

#{{ slider_id }} .prev{ left:12px; }
#{{ slider_id }} .next{ right:12px; }

#{{ slider_id }} .dots{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:14px;
  display:flex;
  gap:8px;
  z-index:5;
}

#{{ slider_id }} .dot{
  width:8px;
  height:8px;
  border:none;
  border-radius:999px;
  background:rgba(255,255,255,.55);
  box-shadow:0 2px 8px rgba(0,0,0,.25);
  cursor:pointer;
}

#{{ slider_id }} .dot.is-active{
  background:#edc68d;
}

@media (max-width: 768px){
  #{{ slider_id }} .slide{
    aspect-ratio:16 / 9;
  }
}

@media (prefers-reduced-motion: reduce){
  #{{ slider_id }} *{
    animation:none !important;
    transition:none !important;
  }
}
</style>

<script>
(function(){
  const root = document.getElementById('{{ slider_id }}');
  if(!root) return;
  const slides = [...root.querySelectorAll('.slide')];
  const dots   = [...root.querySelectorAll('.dot')];
  const prev   = root.querySelector('.prev');
  const next   = root.querySelector('.next');
  let i = 0, t = null, delay = 6500;

  function setSlide(n){
    i = (n + slides.length) % slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('is-active', idx===i));
    dots.forEach((d,idx)=>{
      d.classList.toggle('is-active', idx===i);
      d.setAttribute('aria-selected', idx===i ? 'true' : 'false');
    });
  }

  function play(){ stop(); t = setInterval(()=>setSlide(i+1), delay); }
  function stop(){ if(t){ clearInterval(t); t = null; } }

  if (prev) prev.addEventListener('click', ()=>{ setSlide(i-1); play(); });
  if (next) next.addEventListener('click', ()=>{ setSlide(i+1); play(); });

  dots.forEach(d=>{
    d.addEventListener('click', ()=>{
      const idx = +d.dataset.index;
      setSlide(idx);
      play();
    });
  });

  let x0 = null;
  root.addEventListener('touchstart', e=>{
    x0 = e.touches[0].clientX;
    stop();
  }, {passive:true});

  root.addEventListener('touchend', e=>{
    if(x0 === null) return;
    const dx = e.changedTouches[0].clientX - x0;
    if(Math.abs(dx) > 30) setSlide(i + (dx < 0 ? 1 : -1));
    x0 = null;
    play();
  });

  setSlide(0);
  play();
})();
</script>

{% schema %}
{
  "name": "ANAJ – slider z hotspotem",
  "tag": "section",
  "class": "section",
  "settings": [],
  "blocks": [
    {
      "type": "slide",
      "name": "Slajd",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Obraz tła (16:9 zalecane)" },
        { "type": "url", "id": "cta_link", "label": "Link przycisku CTA" },
        { "type": "text", "id": "cta_label", "label": "Tekst przycisku CTA", "default": "Zamów teraz" },
        { "type": "range", "id": "cta_x", "label": "Poziome położenie przycisku (X)", "min": 0, "max": 100, "step": 1, "default": 50 },
        { "type": "range", "id": "cta_y", "label": "Pionowe położenie przycisku (Y)", "min": 0, "max": 100, "step": 1, "default": 80 }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "ANAJ – slider z hotspotem",
      "category": "Banner",
      "blocks": [
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
