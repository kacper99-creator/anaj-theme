{%- if product -%}
  {%- assign _sid = section.id | default: product.id -%}
  {%- assign ROOT = 'anaj-pdp-' | append: _sid -%}
  {%- assign GID = ROOT | append: '-gal' -%}
  {%- assign gallery = product.images -%}
  {%- assign variants = product.variants -%}
  {%- assign vSel = product.selected_or_first_available_variant -%}

  <div id="{{ ROOT }}" class="anaj-pdp" data-vid="{{ vSel.id }}">
    {% if gallery and gallery.size > 0 %}
      <div id="{{ GID }}" class="anaj-gal" style="grid-area: gal;">
        {% assign first = gallery.first %}

        <div class="anaj-gal__stage">
          <div class="anaj-gal__track">
            {% for img in gallery %}
              <div class="anaj-gal__slide">
                <img
                  src="{{ img | image_url: width: 1600 }}"
                  alt="{{ img.alt | escape | default: product.title }}"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  {% if forloop.first %}fetchpriority="high"{% endif %}
                >
              </div>
            {% endfor %}
          </div>

          <button class="anaj-gal__nav is-prev" aria-label="Poprzednie zdjƒôcie">‚Äπ</button>
          <button class="anaj-gal__nav is-next" aria-label="Nastƒôpne zdjƒôcie">‚Ä∫</button>
        </div>
      </div>
    {% endif %}

    <script type="application/json" id="{{ GID }}-images">
      [
        {% for img in gallery %}
          "{{ img | image_url: width: 1600 }}"{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    </script>

    <div class="anaj-right" style="grid-area: info;">
      {%- comment -%} HERO {%- endcomment -%}
      <header class="anaj-head">
        <div class="anaj-head__top">
          <span class="anaj-pill">
            {{ section.settings.pill_label | default: 'Rzemie≈õlniczy wypiek' }}
          </span>
        </div>
        {% comment %} Delikatne t≈Ço premium pod tytu≈Çem dla lepszej czytelno≈õci {% endcomment %}
        <div class="anaj-title-wrapper">
          <h1 class="anaj-title">{{ product.title }}</h1>
        </div>
      </header>

      {%- comment -%} CENA + STAN {%- endcomment -%}
      <div class="anaj-card anaj-price" id="{{ ROOT }}-price">
        <div class="anaj-price__left">
          <span class="anaj-price__current">{{ vSel.price | money }}</span>
          {% if vSel.compare_at_price > vSel.price %}
            <span class="anaj-price__compare">{{ vSel.compare_at_price | money }}</span>
            <span class="anaj-price__badge">
              -{{ vSel.compare_at_price | minus: vSel.price | times: 100 | divided_by: vSel.compare_at_price }}%
            </span>
          {% endif %}
        </div>
        <div class="anaj-price__right">
          <span class="anaj-price__stock">
            {% if vSel.available %}Wypiek na bie≈ºƒÖco{% else %}Wyprzedane{% endif %}
          </span>
        </div>
      </div>

      {%- assign mf = product.metafields -%}
      {%- assign cutoff = mf.anaj.cutoff_hour | default: 20 -%}
      {%- assign free = mf.anaj.free_ship_threshold | default: 199 -%}

      {% comment %}
        Teksty akordeon√≥w z ustawie≈Ñ sekcji z fallbackiem do metafield√≥w i domy≈õlnych tre≈õci
      {% endcomment %}
      {%- assign ingredients = section.settings.acc_ingredients
        | default: mf.anaj.ingredients
        | default: "zgodny z recepturƒÖ Cechu Cukiernik√≥w i Piekarzy w Poznaniu. MƒÖka pszenna, cukier, t≈Çuszcz ro≈õlinny w zmiennych proporcjach palmowy, rzepakowy i kokosowy, jajka ≈õwie≈ºe, mak bia≈Çy, dro≈ºd≈ºe, mleko w proszku pe≈Çne, orzechy arachidowe 3%, rodzynki 3%, sk√≥rka pomara≈Ñczowa, aromat migda≈Çowy."
      -%}

      {%- assign allergens = section.settings.acc_allergens
        | default: mf.anaj.allergens
        | default: "jaja, mleko, orzechy arachidowe"
      -%}

      {%- assign storage = section.settings.acc_storage
        | default: mf.anaj.storage
        | default: "Przechowywaƒá w ch≈Çodnym, suchym miejscu. Najlepszy smak po lekkim podgrzaniu."
      -%}

      {%- assign shelf = section.settings.acc_shelf
        | default: mf.anaj.shelf_life
        | default: "Najlepiej spo≈ºyƒá w ciƒÖgu 3 dni od dostawy."
      -%}

      {%- assign nutrition = section.settings.acc_nutrition | default: mf.anaj.nutrition -%}

      {%- comment -%} WARIANTY / ILO≈öƒÜ SZTUK {%- endcomment -%}
      {% unless product.has_only_default_variant %}
        <form class="anaj-variants anaj-card" onsubmit="return false;">
          {% for option in product.options_with_values %}
            <label class="anaj-variants__label" for="{{ ROOT }}-opt-{{ forloop.index0 }}">{{ option.name }}</label>
            <select
              id="{{ ROOT }}-opt-{{ forloop.index0 }}"
              class="anaj-variants__select"
              data-opt="{{ forloop.index0 }}"
            >
              {% for value in option.values %}
                <option
                  value="{{ value | escape }}"
                  {% if option.selected_value == value %}selected{% endif %}
                >
                  {{ value }}
                </option>
              {% endfor %}
            </select>
          {% endfor %}
        </form>
      {% endunless %}

      {%- comment -%} USP POD ILO≈öCIƒÑ SZTUK {%- endcomment -%}
      <ul class="anaj-usp">
        <li>{{ section.settings.usp_1 | default: '≈öwie≈ºo wypiekane na zam√≥wienie' }}</li>
        <li>{{ section.settings.usp_2 | default: 'Dostawa dzie≈Ñ roboczy po wypieku' }}</li>
      </ul>

      {%- comment -%} CTA {%- endcomment -%}
      <div class="anaj-ctaBar">
        <!-- Dodaj do koszyka -->
        <form class="anaj-form anaj-card--ghost" method="post" action="/cart/add">
          <input type="hidden" name="id" value="{{ vSel.id }}">
          <input type="hidden" name="quantity" value="1">
          <button
            class="anaj-btn anaj-btn--add"
            type="submit"
            {% unless vSel.available %}disabled{% endunless %}
            aria-label="Dodaj do koszyka"
          >
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path
                fill="currentColor"
                d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2Zm10 0a 2 2 0 1 0 2 2 2 2 0 0 0-2-2ZM3 4h2l2.2 9.5a2 2 0 0 0 2 1.5h7.3a2 2 0 0 0 1.9-1.4L20 9H8"
              ></path>
              <path d="M10 5l1.2-2h3.6L16 5"></path>
            </svg>
            Dodaj do koszyka
          </button>
        </form>

        <!-- Kup teraz -->
        <form class="anaj-form anaj-card--ghost" method="post" action="/cart/add">
          <input type="hidden" name="id" value="{{ vSel.id }}">
          <input type="hidden" name="quantity" value="1">
          <input type="hidden" name="return_to" value="/checkout">
          <button
            class="anaj-btn anaj-btn--buy"
            type="submit"
            {% unless vSel.available %}disabled{% endunless %}
            aria-label="Kup teraz"
          >
            Kup teraz
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path
                fill="currentColor"
                d="M13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41L13.17 12z"
              ></path>
            </svg>
          </button>
        </form>
      </div>

      {%- comment -%} O≈ö ZAM√ìWIENIA ‚Äì standardowo do 3 dni roboczych {%- endcomment -%}
      {%- assign now_s = 'now' | date: '%s' | plus: 0 -%}
      {%- assign day = 86400 -%}
      {%- assign dow = 'now' | date: '%w' | plus: 0 -%}
      {%- assign ship_offset = 2 -%}
      {%- assign deliv_offset = 3 -%}

      {%- case dow -%}
        {%- when 1 -%}
          {%- assign ship_offset = 2 -%}
          {%- assign deliv_offset = 3 -%}
        {%- when 2 -%}
          {%- assign ship_offset = 2 -%}
          {%- assign deliv_offset = 3 -%}
        {%- when 3 -%}
          {%- assign ship_offset = 2 -%}
          {%- assign deliv_offset = 5 -%}
        {%- when 4 -%}
          {%- assign ship_offset = 4 -%}
          {%- assign deliv_offset = 5 -%}
        {%- when 5 -%}
          {%- assign ship_offset = 4 -%}
          {%- assign deliv_offset = 5 -%}
        {%- when 6 -%}
          {%- assign ship_offset = 3 -%}
          {%- assign deliv_offset = 4 -%}
        {%- when 0 -%}
          {%- assign ship_offset = 2 -%}
          {%- assign deliv_offset = 3 -%}
      {%- endcase -%}

      {%- assign ship_s = ship_offset | times: day | plus: now_s -%}
      {%- assign deliv_s = deliv_offset | times: day | plus: now_s -%}

      <div class="anaj-timeline anaj-card">
        <div class="anaj-tl__header">
          <span class="anaj-tl__eyebrow">Kiedy otrzymasz zam√≥wienie?</span>
          <p class="anaj-tl__hint">Standardowo do 3 dni roboczych.</p>
        </div>

        <div class="anaj-tl">
          <div class="anaj-tl__line" aria-hidden="true"></div>

          <div class="anaj-tl__step">
            <div class="anaj-tl__dot" aria-hidden="true">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                fill="none"
                stroke="#fff"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="9" cy="19" r="1.5"></circle>
                <circle cx="16" cy="19" r="1.5"></circle>
                <path
                  d="M3 5h2l2.2 9.5a2 2 0 0 0 2 1.5h7.3a2 2 0 0 0 1.9-1.4L20 9H8"
                ></path>
                <path d="M10 5l1.2-2h3.6L16 5"></path>
              </svg>
            </div>
            <div class="anaj-tl__meta">
              <div class="anaj-tl__date">{{ now_s | date: "%d.%m" }}</div>
              <div class="anaj-tl__label">Zam√≥wienie</div>
            </div>
          </div>

          <div class="anaj-tl__step">
            <div class="anaj-tl__dot" aria-hidden="true">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                fill="none"
                stroke="#fff"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="6" width="11" height="8" rx="1.5"></rect>
                <path d="M14 9h4l3 4v1h-2.5"></path>
                <circle cx="7" cy="18" r="1.6"></circle>
                <circle cx="17" cy="18" r="1.6"></circle>
              </svg>
            </div>
            <div class="anaj-tl__meta">
              <div class="anaj-tl__date">{{ ship_s | date: "%d.%m" }}</div>
              <div class="anaj-tl__label">Wypiek &amp; wysy≈Çka</div>
            </div>
          </div>

          <div class="anaj-tl__step">
            <div class="anaj-tl__dot" aria-hidden="true">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                fill="none"
                stroke="#fff"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="4" y="9" width="16" height="11" rx="1.5"></rect>
                <path d="M4 12h16M12 9v11"></path>
                <path d="M8.5 9V6a2 2 0 0 1 4 0v3M15.5 9V6a 2 2 0 0 0-4 0"></path>
              </svg>
            </div>
            <div class="anaj-tl__meta">
              <div class="anaj-tl__date">{{ deliv_s | date: "%d.%m" }}</div>
              <div class="anaj-tl__label">Dostawa</div>
            </div>
          </div>
        </div>
      </div>

      {%- comment -%} AKORDEONY ‚Äì domy≈õlnie zamkniƒôte {%- endcomment -%}
      <details class="anaj-acc__item anaj-card">
        <summary>O produkcie</summary>
        <div class="anaj-acc__content">
          {{ product.description | default: 'Brak dodatkowego opisu produktu.' }}
        </div>
      </details>

      {% if ingredients or allergens %}
        <details class="anaj-acc__item anaj-card">
          <summary>Sk≈Çad i alergeny</summary>
          <div class="anaj-acc__content">
            {% if ingredients %}
              <p>
                <strong>Sk≈Çad</strong> ‚Äî {{ ingredients | escape | newline_to_br }}
              </p>
            {% endif %}

            {% if allergens %}
              <p>
                <strong>Alergeny:</strong>
                {% if allergens.value %}
                  {{ allergens.value | join: ', ' }}
                {% else %}
                  {{ allergens }}
                {% endif %}
              </p>
            {% endif %}
          </div>
        </details>
      {% endif %}

      <details class="anaj-acc__item anaj-card">
        <summary>Warto≈õci od≈ºywcze (na 100 g)</summary>
        <div class="anaj-acc__content">
          {% if nutrition %}
            {{ nutrition }}
          {% else %}
            <div class="anaj-nutri">
              <!-- fallback -->
              <div class="anaj-nutri__row">
                <span>Warto≈õƒá energetyczna</span><strong>411,31 kcal ‚Ä¢ 1719,88 kJ</strong>
              </div>
              <div class="anaj-nutri__row">
                <span>T≈Çuszcz</span><strong>22,5 g</strong>
              </div>
              <div class="anaj-nutri__sub">
                <span>‚Äî kwasy t≈Çuszczowe nasycone</span><strong>6,1 g</strong>
              </div>
              <div class="anaj-nutri__sub">
                <span>‚Äî kwasy t≈Çuszczowe nienasycone</span><strong>14,22 g</strong>
              </div>
              <div class="anaj-nutri__row">
                <span>Bia≈Çko</span><strong>7,78 g</strong>
              </div>
              <div class="anaj-nutri__row">
                <span>Woda</span><strong>24,24 g</strong>
              </div>
              <div class="anaj-nutri__row">
                <span>Wƒôglowodany og√≥≈Çem</span><strong>44,31 g</strong>
              </div>
              <div class="anaj-nutri__sub">
                <span>‚Äî w tym cukry</span><strong>21,13 g</strong>
              </div>
              <div class="anaj-nutri__row">
                <span>Chlorek sodu</span><strong>0,16 g</strong>
              </div>
              <p class="anaj-nutri__foot">
                Warto≈õci wg bada≈Ñ laboratorium Nuscana (na 100 g produktu gotowego).
              </p>
            </div>
          {% endif %}
        </div>
      </details>

      <details class="anaj-acc__item anaj-card">
        <summary>Przechowywanie i ≈õwie≈ºo≈õƒá</summary>
        <div class="anaj-acc__content">
          <p>{{ storage }}</p>
          <p><strong>Termin przydatno≈õci:</strong> {{ shelf }}</p>
        </div>
      </details>

      <details class="anaj-acc__item anaj-card">
        <summary>Szczeg√≥≈Çy dostawy</summary>
        <div class="anaj-acc__content">
          <p>
            üïí <strong>Zam√≥wienia z≈Ço≈ºone do godziny {{ cutoff }}:00</strong><br>
            sƒÖ przygotowywane <strong>nastƒôpnego dnia roboczego</strong>
            (od poniedzia≈Çku do czwartku) i <strong>wysy≈Çane po wypieku oraz sch≈Çodzeniu</strong>.<br>
            <em>Dostawa nastƒôpuje dzie≈Ñ roboczy po wypieku</em>.
          </p>
          <p>
            üì¶ <strong>Zam√≥wienia z≈Ço≈ºone po {{ cutoff }}:00</strong>
            przechodzƒÖ do realizacji w kolejnej turze.
          </p>
          <p>üö´ W piƒÖtki, weekendy i ≈õwiƒôta nie wysy≈Çamy paczek.</p>
        </div>
      </details>

      <div class="anaj-card anaj-banner">
        {% if section.settings.banner_image != blank %}
          <img
            src="{{ section.settings.banner_image | image_url: width: 800 }}"
            alt="{{ section.settings.banner_alt | default: 'P≈Çatno≈õci i dostawa' }}"
            loading="lazy"
            width="1600"
            height="640"
          >
        {% else %}
          <img
            src="https://cdn.shopify.com/s/files/1/0994/5196/1676/files/xx.webp?v=1762705077"
            alt="P≈Çatno≈õci i dostawa"
            loading="lazy"
            width="1600"
            height="640"
          >
        {% endif %}
      </div>
    </div>
  </div>

  <script type="application/json" id="{{ ROOT }}-vmap">
    [
      {% for v in variants %}
        {
          "id": {{ v.id }},
          "available": {{ v.available | json }},
          "price_cents": {{ v.price | json }},
          "compare_cents": {{ v.compare_at_price | default: 0 | json }},
          "opt1": {{ v.option1 | json }},
          "opt2": {{ v.option2 | json }},
          "opt3": {{ v.option3 | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>

  <style>
    /* === 1. G≈Å√ìWNY KONTENER PDP === */
    #{{ ROOT }}{
      --ink:#2b2219;
      --ring:rgba(185,142,85,.45);
      --border:#B98E55;
      --surface-top:#F3E1C6;
      --surface-bot:#E2BE8F;
      --chip:#EDE0CC;
      --chip-border:#D9C2A4;
      --padx: clamp(16px,4vw,40px);
      --pady: clamp(14px,3vw,28px);

      font-family: var(--font-body-family);
      color:var(--ink);

      box-sizing:border-box;
      max-width:100vw;
      width:100%;
      margin:0 auto;

      background:
        linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,0)),
        repeating-linear-gradient(90deg, #f4e6d1 0 24px, #ead6b6 24px 48px);

      padding-inline:var(--padx);
      padding-block:var(--pady);

      display:grid;
      gap:24px;
      grid-template-areas:"gal" "info";

      /* klucz do centrowania ca≈Çej zawarto≈õci na mobile */
      justify-items:center;

      overflow-x:hidden;
      transform:none;
    }

    /* [PDP-FIX-MOBILE-LAYOUT] ‚Äì centrowanie galerii i prawej kolumny */
    #{{ ROOT }} .anaj-gal,
    #{{ ROOT }} .anaj-right {
      width:100%;
      max-width:480px;
      box-sizing:border-box;
    }

    @media (min-width:1024px){
      #{{ ROOT }}{
        grid-template-columns:minmax(0, 1.15fr) minmax(0, 0.95fr);
        grid-template-areas:"gal info";
        align-items:start;
        min-height:100vh;
        justify-items:stretch;
      }

      #{{ ROOT }} .anaj-gal,
      #{{ ROOT }} .anaj-right{
        max-width:none;
      }
    }

    /* === 2. GALERIA ‚Äì slider 4:3 === */
    #{{ GID }} .anaj-gal__stage{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      background:transparent;
      box-shadow:0 14px 30px rgba(0,0,0,.12);
      touch-action:pan-y;
      aspect-ratio:4 / 3;
    }

    #{{ GID }} .anaj-gal__track{
      display:flex;
      width:100%;
      height:100%;
      transition:transform .4s ease-out;
    }

    #{{ GID }} .anaj-gal__slide{
      min-width:100%;
      aspect-ratio:4 / 3;
    }

    #{{ GID }} .anaj-gal__slide img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    #{{ GID }} .anaj-gal__nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      z-index:10;
      width:46px;
      height:46px;
      border-radius:999px;
      background:#fff !important;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 14px 28px rgba(0,0,0,.18);
      cursor:pointer;
      pointer-events:auto;
    }

    #{{ GID }} .anaj-gal__nav.is-prev{
      left:12px;
    }

    #{{ GID }} .anaj-gal__nav.is-next{
      right:12px;
    }

    /* === 3. CARD + CENA === */
    #{{ ROOT }} .anaj-card{
      background:linear-gradient(180deg,var(--surface-top),var(--surface-bot)) !important;
      border:1px solid var(--border) !important;
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 34px rgba(93,62,28,.16) !important;
    }

    #{{ ROOT }} .anaj-price{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    #{{ ROOT }} .anaj-price__left{
      display:flex;
      align-items:baseline;
      gap:8px;
    }

    #{{ ROOT }} .anaj-price__current{
      font-weight:900;
      font-size:clamp(24px,2.6vw,34px);
    }

    #{{ ROOT }} .anaj-price__compare{
      text-decoration:line-through;
      opacity:.6;
    }

    #{{ ROOT }} .anaj-price__badge{
      background:#2e2418;
      color:#fff;
      border-radius:999px;
      padding:3px 9px;
      font-weight:800;
      font-size:11px;
    }

    #{{ ROOT }} .anaj-price__right{
      margin-left:auto;
    }

    #{{ ROOT }} .anaj-price__stock{
      font-size:13px;
      font-weight:600;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.06);
    }

    /* [PDP-VARIANTS] ‚Äì wycentrowane pole ‚Äûilo≈õƒá sztuk‚Äù */
    #{{ ROOT }} .anaj-variants{
      display:grid;
      gap:8px;
      margin-top:8px;
      justify-items:center;
    }

    #{{ ROOT }} .anaj-variants__label{
      font-size:13px;
      font-weight:600;
      text-align:center;
    }

    #{{ ROOT }} .anaj-variants__select{
      width:100%;
      max-width:260px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      padding:8px 14px;
      font-size:14px;
      background:#fff;
    }

    /* USP pod ilo≈õciƒÖ */
    #{{ ROOT }} .anaj-usp{
      list-style:none;
      margin:8px 0 10px 0;
      padding:0;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }

    #{{ ROOT }} .anaj-usp li{
      background:linear-gradient(180deg,#FFF9EF,#F1DFC3) !important;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--chip-border) !important;
      font-size:13px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }

    /* === CTA === */
    #{{ ROOT }} .anaj-ctaBar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin-top:8px;
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-form{
      margin:0;
      width:100%;
      max-width:420px;
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn{
      all:unset;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      min-height:52px;
      padding:14px 24px;
      border-radius:9999px;
      font:inherit;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    @media (min-width:1024px){
      #{{ ROOT }} .anaj-ctaBar{
        justify-content:center;
      }
      #{{ ROOT }} .anaj-ctaBar .anaj-btn{
        width:auto;
        min-width:220px;
      }
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn--add{
      background:linear-gradient(180deg,#F6C97D,#D79B4C) !important;
      color:#2b2219 !important;
      border:1px solid #C4873A !important;
      box-shadow:0 10px 20px rgba(115,79,35,.22) !important;
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn--buy{
      background:linear-gradient(180deg,#5b3a1c,#2f1c0c) !important;
      color:#fff !important;
      border:1px solid rgba(0,0,0,.6) !important;
      box-shadow:0 10px 24px rgba(0,0,0,.35) !important;
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn:hover:not([disabled]){
      transform:translateY(-1px) scale(1.01);
      box-shadow:0 14px 28px rgba(0,0,0,.28);
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn:active:not([disabled]){
      transform:translateY(0) scale(.99);
      box-shadow:0 8px 18px rgba(0,0,0,.20);
    }

    #{{ ROOT }} .anaj-ctaBar .anaj-btn:focus-visible{
      outline:2px solid var(--ring);
      outline-offset:2px;
    }

    /* === TIMELINE === */
    #{{ ROOT }} .anaj-timeline{
      --gold1:#D9A055;
      --gold2:#B98E55;
      --muted:#6a5944;

      margin-top:14px;
      background:linear-gradient(180deg,#F3E1C6,#E2BE8F);
      border:1px solid var(--gold2);
      border-radius:16px;
      padding:14px;
      box-shadow:0 18px 34px rgba(93,62,28,.16);
    }

    #{{ ROOT }} .anaj-tl__header{
      margin-bottom:8px;
      text-align:center;
    }

    #{{ ROOT }} .anaj-tl__eyebrow{
      display:block;
      font-size:12px;
      font-weight:800;
      letter-spacing:.16em;
      text-transform:uppercase;
    }

    #{{ ROOT }} .anaj-tl__hint{
      margin:2px 0 0;
      font-size:12px;
      opacity:.8;
    }

    #{{ ROOT }} .anaj-tl{
      position:relative;
      display:flex;
      justify-content:space-between;
      gap:18px;
      margin-top:8px;
    }

    #{{ ROOT }} .anaj-tl__line{
      position:absolute;
      top:22px;
      left:40px;
      right:40px;
      height:3px;
      background:linear-gradient(90deg,var(--gold1),var(--gold2));
      border-radius:3px;
      box-shadow:0 0 0 1px rgba(185,142,85,.25);
    }

    #{{ ROOT }} .anaj-tl__step{
      position:relative;
      text-align:center;
      flex:1 1 0;
    }

    #{{ ROOT }} .anaj-tl__dot{
      width:36px;
      height:36px;
      margin:0 auto 8px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:radial-gradient(65% 65% at 50% 45%, var(--gold1) 0%, var(--gold2) 100%);
      box-shadow:
        0 0 0 3px #fff inset,
        0 10px 20px rgba(115,79,35,.25),
        0 0 0 1px rgba(185,142,85,.25);
    }

    #{{ ROOT }} .anaj-tl__date{
      font-weight:900;
      font-size:14.5px;
      color:#2b2219;
      text-shadow:0 1px 0 rgba(255,255,255,.55);
    }

    #{{ ROOT }} .anaj-tl__label{
      margin-top:2px;
      font-weight:800;
      color:var(--muted);
      font-size:12.6px;
      background:#EDE0CC;
      border:1px solid rgba(0,0,0,.06);
      border-radius:10px;
      display:inline-block;
      padding:2px 8px;
    }

    @media (max-width:540px){
      #{{ ROOT }} .anaj-timeline{padding:12px}
      #{{ ROOT }} .anaj-tl{gap:12px}
      #{{ ROOT }} .anaj-tl__line{left:28px; right:28px}
      #{{ ROOT }} .anaj-tl__dot{width:32px; height:32px; margin-bottom:6px}
      #{{ ROOT }} .anaj-tl__date{font-size:13.6px}
      #{{ ROOT }} .anaj-tl__label{font-size:12px}
    }

    /* === AKORDEONY / NUTRIA === */
    #{{ ROOT }} .anaj-acc__item > summary{
      padding:12px 14px;
      cursor:pointer;
      list-style:none;
      font-weight:700;
      border-radius:12px;
    }

    #{{ ROOT }} .anaj-acc__item > summary::-webkit-details-marker{
      display:none;
    }

    #{{ ROOT }} .anaj-acc__content{
      padding:0 14px 12px 14px;
    }

    #{{ ROOT }} .anaj-nutri{
      display:grid;
      gap:6px;
    }

    #{{ ROOT }} .anaj-nutri__row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:6px 0;
      border-bottom:1px dashed rgba(0,0,0,.08);
    }

    #{{ ROOT }} .anaj-nutri__sub{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:4px 0 4px 12px;
      font-size:14px;
      opacity:.95;
    }

    #{{ ROOT }} .anaj-nutri__foot{
      margin-top:8px;
      font-size:12px;
      opacity:.75;
    }

    /* Baner p≈Çatno≈õci ‚Äì mniejszy na desktopie */
    #{{ ROOT }} .anaj-banner{
      padding:0;
      overflow:hidden;
      margin-top:12px;
      text-align:center;
    }

    #{{ ROOT }} .anaj-banner img{
      display:block;
      width:100%;
      height:auto;
      object-fit:cover;
    }

    @media (min-width:1024px){
      #{{ ROOT }} .anaj-banner img{
        width:auto;
        max-width:360px;
        margin-inline:auto;
      }
    }

    /* Font + globalny reset w sekcji */
    #{{ ROOT }},
    #{{ ROOT }} * {
      font-family: var(--font-body-family), system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif !important;
      font-feature-settings: "kern" 1, "liga" 1;
    }

    /* === TYTU≈Å === */
    #{{ ROOT }} .anaj-head{
      margin-bottom: 10px;
      text-align: center;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    #{{ ROOT }} .anaj-head__top{
      display:flex;
      justify-content:center;
      margin-bottom:4px;
    }

    #{{ ROOT }} .anaj-pill{
      padding:5px 14px;
      border-radius:999px;
      background:linear-gradient(180deg,#6b4121,#3f2411);
      color:#fff;
      font-size:11px;
      font-weight:800;
      letter-spacing:.16em;
      text-transform:uppercase;
      box-shadow:0 6px 14px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
    }

    #{{ ROOT }} .anaj-head__top,
    #{{ ROOT }} .anaj-head__top::before,
    #{{ ROOT }} .anaj-head__top::marker,
    #{{ ROOT }} .anaj-pill::before,
    #{{ ROOT }} .anaj-pill::marker{
      content:none;
      list-style:none;
    }

    /* [PDP-TITLE] ‚Äì g≈Ç√≥wny tytu≈Ç produktu */
    #{{ ROOT }} .anaj-title{
      margin:6px 0 0 0;
      text-align:center;
      text-transform:uppercase;
      letter-spacing:.03em;
      font-weight:900 !important;
      font-size:clamp(28px, 3.4vw, 40px) !important;
      line-height:1.08 !important;
      display:inline-block;
      color:#4b2a16 !important;
      background:none !important;
      -webkit-background-clip: initial !important;
      -webkit-text-fill-color: currentColor;
      text-shadow:0 1px 3px rgba(0,0,0,.22);
      hyphens:none;
      word-break:keep-all;
      text-wrap:balance;
      max-width:100%;
      box-sizing:border-box;
    }

    /* p≈Çyta pod tytu≈Çem */
    #{{ ROOT }} .anaj-title-wrapper {
      position: relative;
      display: inline-block;
      padding: 12px 22px;
      border-radius: 14px;
      background: rgba(244, 229, 206, 0.65);
      backdrop-filter: blur(3px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.15);
      margin:6px auto 0 auto;
      max-width:100%;
      box-sizing:border-box;
    }

    #{{ ROOT }} .anaj-title::after{
      content:"";
      display:block;
      width:clamp(110px, 28vw, 210px);
      height:6px;
      margin:12px auto 0;
      border-radius:999px;
      background:linear-gradient(90deg,#fef4dd 0%, #f6c97d 48%, #d79b4c 100%);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
    }

    /* [PDP-TITLE-DESKTOP] ‚Äì delikatne dopieszczenie */
    @media (min-width: 1024px){
      #{{ ROOT }} .anaj-title{
        font-size:clamp(30px, 3vw, 38px) !important;
        max-width:24ch;
      }

      #{{ ROOT }} .anaj-title-wrapper {
        padding: 16px 32px;
        border-radius: 18px;
        max-width:26ch;
      }
    }

    /* [PDP-TITLE-MOBILE] ‚Äì wiƒôkszy, szerszy hero na telefonach */
    @media (max-width: 750px){
      #{{ ROOT }} .anaj-title{
        font-size:clamp(24px, 7vw, 32px) !important;
        letter-spacing:.025em;
        line-height:1.16 !important;
        padding-inline:4px;
        max-width:100%;
      }

      #{{ ROOT }} .anaj-title-wrapper{
        padding:12px 16px;
        border-radius:16px;
        max-width:100%;
      }

      #{{ ROOT }} .anaj-title::after{
        width:min(160px, 60vw);
        margin-top:10px;
      }
    }

    /* [PDP-TITLE-MOBILE-XS] ‚Äì awaryjne ≈Çamanie bardzo d≈Çugich s≈Ç√≥w */
    @media (max-width: 480px){
      #{{ ROOT }} .anaj-title{
        word-break:break-word;
      }
    }

    /* Animacja accordion√≥w */
    #{{ ROOT }} .anaj-acc__item{
      border-radius:16px;
      overflow:hidden;
    }

    #{{ ROOT }} .anaj-acc__item > summary{
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      position:relative;
    }

    #{{ ROOT }} .anaj-acc__item > summary::after{
      content:'+';
      margin-left:auto;
      font-weight:900;
      font-size:18px;
      transition:transform .22s ease;
    }

    #{{ ROOT }} .anaj-acc__item[open] > summary::after{
      transform:rotate(45deg);
    }

    #{{ ROOT }} .anaj-acc__item .anaj-acc__content{
      max-height:0;
      opacity:0;
      transform:translateY(-4px);
      overflow:hidden;
      transition:max-height .3s ease, opacity .22s ease, transform .22s ease;
    }

    #{{ ROOT }} .anaj-acc__item[open] .anaj-acc__content{
      max-height:650px;
      opacity:1;
      transform:translateY(0);
    }

    /* Przywracamy pogrubienia w tre≈õci */
    #{{ ROOT }} strong,
    #{{ ROOT }} b{
      font-weight:700;
    }

    /* Usuniƒôcie przypadkowego bordera nad sekcjƒÖ ceny */
    #{{ ROOT }} [style*="border-top"],
    #{{ ROOT }} .anaj-price{
      border-top:0 !important;
    }

  </style>

  <script>
    (function(){
      try{
        const root = document.getElementById('{{ ROOT }}');
        if (!root) return;

        /* Galeria ‚Äì slider z animacjƒÖ i swipe */
        const gal = document.getElementById('{{ GID }}');
        if (gal) {
          const stage = gal.querySelector('.anaj-gal__stage');
          const track = stage ? stage.querySelector('.anaj-gal__track') : null;
          const slides = track ? Array.from(track.querySelectorAll('.anaj-gal__slide')) : [];
          const prev = gal.querySelector('.anaj-gal__nav.is-prev');
          const next = gal.querySelector('.anaj-gal__nav.is-next');

          if (track && slides.length > 1) {
            let current = 0;
            const N = slides.length;

            const goTo = (n) => {
              current = (n + N) % N;
              track.style.transform = 'translateX(-' + (current * 100) + '%)';
            };

            prev && prev.addEventListener('click', () => goTo(current - 1));
            next && next.addEventListener('click', () => goTo(current + 1));

            let startX = null;
            let currentX = null;

            const onTouchStart = (e) => {
              if (!e.touches || !e.touches.length) return;
              startX = e.touches[0].clientX;
              currentX = startX;
            };

            const onTouchMove = (e) => {
              if (startX === null) return;
              currentX = e.touches[0].clientX;
            };

            const onTouchEnd = () => {
              if (startX === null || currentX === null) {
                startX = currentX = null;
                return;
              }
              const deltaX = currentX - startX;
              const threshold = 40;
              if (Math.abs(deltaX) > threshold) {
                if (deltaX > 0) goTo(current - 1);
                else goTo(current + 1);
              }
              startX = currentX = null;
            };

            stage.addEventListener('touchstart', onTouchStart, { passive: true });
            stage.addEventListener('touchmove', onTouchMove, { passive: true });
            stage.addEventListener('touchend', onTouchEnd);

            goTo(0);
          }
        }

        /* Warianty / cena / synchronizacja formularzy */
        const vmapEl = document.getElementById('{{ ROOT }}-vmap');
        const vmap = vmapEl ? JSON.parse(vmapEl.textContent || '[]') : [];

        const selects = Array.from(root.querySelectorAll('.anaj-variants__select'));

        const fmt = new Intl.NumberFormat(
          '{{ request.locale.iso_code | default: "pl-PL" }}',
          {
            style:'currency',
            currency:'{{ shop.currency | default: "PLN" }}'
          }
        );

        const priceBox = document.getElementById('{{ ROOT }}-price');
        const elCurr  = priceBox ? priceBox.querySelector('.anaj-price__current') : null;
        const elComp  = priceBox ? priceBox.querySelector('.anaj-price__compare') : null;
        const elBadge = priceBox ? priceBox.querySelector('.anaj-price__badge') : null;
        const elStock = priceBox ? priceBox.querySelector('.anaj-price__stock') : null;

        const addForm = root.querySelector('.anaj-ctaBar form:nth-child(1)');
        const buyForm = root.querySelector('.anaj-ctaBar form:nth-child(2)');
        const addBtn  = addForm ? addForm.querySelector('button') : null;
        const buyBtn  = buyForm ? buyForm.querySelector('button') : null;
        const addId   = addForm ? addForm.querySelector('input[name="id"]') : null;
        const buyId   = buyForm ? buyForm.querySelector('input[name="id"]') : null;

        const norm = s => (s ?? '').toString().trim().toLowerCase();

        const resolveVariant = () => {
          if (!vmap.length) return null;

          if (selects.length === 0) {
            const initialId = parseInt(root.dataset.vid, 10);
            return vmap.find(v => v.id === initialId) || vmap[0];
          }

          const want = selects.map(s => norm(s.value));

          return (
            vmap.find(v =>
              [v.opt1, v.opt2, v.opt3]
                .filter(x => x != null)
                .map(norm)
                .every((o, idx) => o === want[idx])
            ) || vmap[0]
          );
        };

        function updateUI(v){
          if (!v) return;

          if (elCurr) {
            elCurr.textContent = fmt.format((v.price_cents || 0) / 100);
          }

          const hasCompare = v.compare_cents && v.compare_cents > v.price_cents;

          if (elComp && elBadge) {
            if (hasCompare) {
              elComp.style.display = 'inline';
              elComp.textContent = fmt.format(v.compare_cents / 100);

              const pct = Math.round(
                (v.compare_cents - v.price_cents) * 100 / v.compare_cents
              );

              elBadge.style.display = 'inline-flex';
              elBadge.textContent = '-' + pct + '%';
            } else {
              elComp.style.display = 'none';
              elBadge.style.display = 'none';
            }
          }

          if (elStock) {
            elStock.textContent = v.available ? 'Wypiek na bie≈ºƒÖco' : 'Wyprzedane';
          }

          if (addBtn) addBtn.disabled = !v.available;
          if (buyBtn) buyBtn.disabled = !v.available;

          if (addId) addId.value = v.id;
          if (buyId) buyId.value = v.id;

          root.dataset.vid = v.id;
        }

        selects.forEach(s =>
          s.addEventListener('change', () => updateUI(resolveVariant()))
        );

        updateUI(resolveVariant());
      } catch(e){
        console.error(e);
      }
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "ANAJ ‚Äì strona produktu",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "pill_label",
      "label": "Badge nad tytu≈Çem",
      "default": "Rzemie≈õlniczy wypiek"
    },
    {
      "type": "text",
      "id": "usp_1",
      "label": "USP #1 pod ilo≈õciƒÖ sztuk",
      "default": "≈öwie≈ºo wypiekane na zam√≥wienie"
    },
    {
      "type": "text",
      "id": "usp_2",
      "label": "USP #2 pod ilo≈õciƒÖ sztuk",
      "default": "Dostawa dzie≈Ñ roboczy po wypieku"
    },
    {
      "type": "image_picker",
      "id": "banner_image",
      "label": "Baner na dole (p≈Çatno≈õci / dostawa)"
    },
    {
      "type": "text",
      "id": "banner_alt",
      "label": "Tekst ALT dla banera",
      "default": "P≈Çatno≈õci i dostawa"
    },
    {
      "type": "textarea",
      "id": "acc_ingredients",
      "label": "Sk≈Çad ‚Äì tre≈õƒá w akordeonie",
      "info": "Tre≈õƒá wy≈õwietlana w sekcji ‚ÄûSk≈Çad i alergeny‚Äù. Je≈õli puste, u≈ºyje domy≈õlnej lub metafield."
    },
    {
      "type": "textarea",
      "id": "acc_allergens",
      "label": "Alergeny ‚Äì tre≈õƒá w akordeonie",
      "info": "Tekst po etykiecie ‚ÄûAlergeny:‚Äù. Je≈õli puste, u≈ºyje domy≈õlnej lub metafield."
    },
    {
      "type": "richtext",
      "id": "acc_nutrition",
      "label": "Warto≈õci od≈ºywcze (na 100 g)",
      "info": "Je≈õli wype≈Çnione, nadpisuje domy≈õlne warto≈õci lub metafield."
    },
    {
      "type": "textarea",
      "id": "acc_storage",
      "label": "Przechowywanie i ≈õwie≈ºo≈õƒá ‚Äì opis",
      "info": "Je≈õli puste, u≈ºyje tre≈õci domy≈õlnej lub metafield."
    },
    {
      "type": "text",
      "id": "acc_shelf",
      "label": "Termin przydatno≈õci",
      "info": "Wy≈õwietlane po etykiecie ‚ÄûTermin przydatno≈õci:‚Äù. Je≈õli puste, u≈ºyje tre≈õci domy≈õlnej lub metafield."
    }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "ANAJ ‚Äì strona produktu",
      "category": "Produkty"
    }
  ]
}
{% endschema %}
