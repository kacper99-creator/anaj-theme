{%- if product -%}
  {%- assign _sid = section.id | default: product.id -%}
  {%- assign ROOT = 'anaj-pdp-' | append: _sid -%}
  {%- assign GID = ROOT | append: '-gal' -%}
  {%- assign gallery = product.images -%}
  {%- assign variants = product.variants -%}
  {%- assign vSel = product.selected_or_first_available_variant -%}

  <!-- T≈ÅO Z PASKAMI W ≈öRODKU (DESKTOP) -->
  <div class="anaj-pdp-bg"></div>

  <div id="{{ ROOT }}" class="anaj-pdp" data-vid="{{ vSel.id }}">
    <div class="anaj-pdp__inner">
      <!-- LEWA KOLUMNA: GALERIA + BADGE/TYTU≈Å (MOBILE) -->
      <div class="anaj-left">

        {% if gallery and gallery.size > 0 %}
          <div id="{{ GID }}" class="anaj-gal">
            {% assign first = gallery.first %}

            <div class="anaj-gal__stage">
              <div class="anaj-gal__track">
                {% for img in gallery %}
                  <div class="anaj-gal__slide">
                    <img
                      src="{{ img | image_url: width: 800 }}"
                      srcset="
                        {{ img | image_url: width: 400 }} 400w,
                        {{ img | image_url: width: 800 }} 800w,
                        {{ img | image_url: width: 1200 }} 1200w,
                        {{ img | image_url: width: 1600 }} 1600w
                      "
                      sizes="(max-width: 768px) 100vw, 50vw"
                      alt="{{ img.alt | escape | default: product.title }}"
                      loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                      {% if forloop.first %}fetchpriority="high"{% endif %}
                    >
                  </div>
                {% endfor %}
              </div>

              <button class="anaj-gal__nav is-prev" type="button" aria-label="Poprzednie zdjƒôcie">‚Äπ</button>
              <button class="anaj-gal__nav is-next" type="button" aria-label="Nastƒôpne zdjƒôcie">‚Ä∫</button>
            </div>
          </div>
        {% endif %}

        <script type="application/json" id="{{ GID }}-images">
          [
            {% for img in gallery %}
              "{{ img | image_url: width: 1600 }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        </script>

        <!-- BADGE + TYTU≈Å TYLKO NA MOBILE -->
        <div class="anaj-pill-mobile">
          <span class="anaj-pill anaj-pill--mobile">
            {{ section.settings.pill_label | default: 'Rzemie≈õlniczy wypiek' }}
          </span>
        </div>
        <div class="anaj-title-wrapper anaj-title-wrapper--mobile">
          <h1 class="anaj-title anaj-title--mobile">{{ product.title }}</h1>
        </div>

        <!-- AKORDEONY DLA DESKTOP -->
        <div class="anaj-extra anaj-extra--left">
          <!-- WSP√ìLNY KOD AKORDEON√ìW -->
          {%- assign mf = product.metafields -%}
          {%- assign ingredients = section.settings.acc_ingredients
            | default: mf.anaj.ingredients
            | default: "zgodny z recepturƒÖ Cechu Cukiernik√≥w i Piekarzy w Poznaniu. MƒÖka pszenna, cukier, t≈Çuszcz ro≈õlinny w zmiennych proporcjach palmowy, rzepakowy i kokosowy, jajka ≈õwie≈ºe, mak bia≈Çy, dro≈ºd≈ºe, mleko w proszku pe≈Çne, orzechy arachidowe 3%, rodzynki 3%, sk√≥rka pomara≈Ñczowa, aromat migda≈Çowy."
          -%}

          {%- assign allergens = section.settings.acc_allergens
            | default: mf.anaj.allergens
            | default: "jaja, mleko, orzechy arachidowe"
          -%}

          {%- assign storage = section.settings.acc_storage
            | default: mf.anaj.storage
            | default: "Przechowywaƒá w ch≈Çodnym, suchym miejscu. Najlepszy smak po lekkim podgrzaniu."
          -%}

          {%- assign shelf = section.settings.acc_shelf
            | default: mf.anaj.shelf_life
            | default: "Najlepiej spo≈ºyƒá w ciƒÖgu 3 dni od dostawy."
          -%}

          {%- assign nutrition = section.settings.acc_nutrition | default: mf.anaj.nutrition -%}

          <details class="anaj-acc__item anaj-card anaj-acc--about">
            <summary>O produkcie</summary>
            <div class="anaj-acc__content">
              {{ product.description | default: 'Brak dodatkowego opisu produktu.' }}
            </div>
          </details>

          {% if ingredients or allergens %}
            <details class="anaj-acc__item anaj-card anaj-acc--ingredients">
              <summary>Sk≈Çad i alergeny</summary>
              <div class="anaj-acc__content">
                {% if ingredients %}
                  <p>
                    <strong>Sk≈Çad</strong> ‚Äî {{ ingredients | escape | newline_to_br }}
                  </p>
                {% endif %}

                {% if allergens %}
                  <p>
                    <strong>Alergeny:</strong>
                    {% if allergens.value %}
                      {{ allergens.value | join: ', ' }}
                    {% else %}
                      {{ allergens }}
                    {% endif %}
                  </p>
                {% endif %}
              </div>
            </details>
          {% endif %}

          <details class="anaj-acc__item anaj-card anaj-acc--nutrition">
            <summary>Warto≈õci od≈ºywcze (na 100 g)</summary>
            <div class="anaj-acc__content">
              {% if nutrition %}
                {{ nutrition }}
              {% else %}
                <div class="anaj-nutri">
                  <div class="anaj-nutri__row">
                    <span>Warto≈õƒá energetyczna</span><strong>411,31 kcal ‚Ä¢ 1719,88 kJ</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>T≈Çuszcz</span><strong>22,5 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî kwasy t≈Çuszczowe nasycone</span><strong>6,1 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî kwasy t≈Çuszczowe nienasycone</span><strong>14,22 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Bia≈Çko</span><strong>7,78 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Woda</span><strong>24,24 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Wƒôglowodany og√≥≈Çem</span><strong>44,31 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî w tym cukry</span><strong>21,13 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Chlorek sodu</span><strong>0,16 g</strong>
                  </div>
                  <p class="anaj-nutri__foot">
                    Warto≈õci wg bada≈Ñ laboratorium Nuscana (na 100 g produktu gotowego).
                  </p>
                </div>
              {% endif %}
            </div>
          </details>

          <details class="anaj-acc__item anaj-card anaj-acc--storage">
            <summary>Przechowywanie i ≈õwie≈ºo≈õƒá</summary>
            <div class="anaj-acc__content">
              <p>{{ storage }}</p>
              <p><strong>Termin przydatno≈õci:</strong> {{ shelf }}</p>
            </div>
          </details>
        </div>
      </div>

      <!-- PRAWY BOK -->
      <div class="anaj-right">
        <!-- NAG≈Å√ìWEK TYLKO NA DESKTOP -->
        <header class="anaj-head anaj-head--desktop">
          <div class="anaj-head__top">
            <span class="anaj-pill anaj-pill--desktop">
              {{ section.settings.pill_label | default: 'Rzemie≈õlniczy wypiek' }}
            </span>
          </div>
          <div class="anaj-title-wrapper anaj-title-wrapper--desktop">
            <h1 class="anaj-title anaj-title--desktop">{{ product.title }}</h1>
          </div>
        </header>

        <!-- CENA + WARIANTY -->
        <div class="anaj-card anaj-price" id="{{ ROOT }}-price">
          <div class="anaj-price__top">
            <div class="anaj-price__left">
              <span class="anaj-price__current">{{ vSel.price | money }}</span>
              {% if vSel.compare_at_price > vSel.price %}
                <span class="anaj-price__compare">{{ vSel.compare_at_price | money }}</span>
                <span class="anaj-price__badge">
                  -{{ vSel.compare_at_price | minus: vSel.price | times: 100 | divided_by: vSel.compare_at_price }}%
                </span>
              {% endif %}
            </div>

            <!-- ILO≈öƒÜ SZTUK -->
            <div class="anaj-price__qty">
              <label class="anaj-qty__label" for="{{ ROOT }}-qty">Ilo≈õƒá</label>
              <select
                id="{{ ROOT }}-qty"
                class="anaj-qty__select"
                data-anaj-qty-select
              >
                {% for i in (1..12) %}
                  <option value="{{ i }}">{{ i }} szt.</option>
                {% endfor %}
              </select>
            </div>
          </div>

          {% unless product.has_only_default_variant %}
            <div class="anaj-price__variants">
              <div class="anaj-variants anaj-variants--inline">
                {% for option in product.options_with_values %}
                  <div class="anaj-variants__item">
                    <label class="anaj-variants__label" for="{{ ROOT }}-opt-{{ forloop.index0 }}">{{ option.name }}</label>
                    <select
                      id="{{ ROOT }}-opt-{{ forloop.index0 }}"
                      class="anaj-variants__select"
                      data-opt="{{ forloop.index0 }}"
                    >
                      {% for value in option.values %}
                        <option
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}selected{% endif %}
                        >
                          {{ value }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endunless %}

          <div class="anaj-price__meta">
            <span class="anaj-price__stock">
              {% if vSel.available %}Wypiek na bie≈ºƒÖco{% else %}Wyprzedane{% endif %}
            </span>
          </div>
        </div>

        {%- assign mf = product.metafields -%}
        {%- assign cutoff = mf.anaj.cutoff_hour | default: 20 -%}
        {%- assign free = mf.anaj.free_ship_threshold | default: 199 -%}

        <!-- JEDEN FORMULARZ Z DWOMA PRZYCISKAMI -->
        <form class="anaj-form" method="post" action="/cart/add" data-anaj-product-form>
          <input type="hidden" name="id" value="{{ vSel.id }}">
          <input type="hidden" name="quantity" value="1" class="anaj-qty-input">
          
          <div class="anaj-ctaBar">
            <button 
              type="submit" 
              name="add-to-cart" 
              class="anaj-btn anaj-btn--add"
              {% unless vSel.available %}disabled{% endunless %}
              aria-label="Dodaj do koszyka"
            >
              <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                <path fill="currentColor" d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2Zm10 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2ZM3 4h2l2.2 9.5a2 2 0 0 0 2 1.5h7.3a2 2 0 0 0 1.9-1.4L20 9H8"></path>
                <path d="M10 5l1.2-2h3.6L16 5"></path>
              </svg>
              Dodaj do koszyka
            </button>
            
            <button 
              type="submit" 
              name="checkout" 
              class="anaj-btn anaj-btn--buy"
              {% unless vSel.available %}disabled{% endunless %}
              aria-label="Kup teraz"
            >
              Kup teraz
              <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                <path fill="currentColor" d="M13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41L13.17 12z"></path>
              </svg>
            </button>
          </div>
        </form>

        <!-- USP -->
        <ul class="anaj-usp">
          <li>{{ section.settings.usp_1 | default: '≈öwie≈ºo wypiekane na zam√≥wienie' }}</li>
          <li>{{ section.settings.usp_2 | default: 'Dostawa dzie≈Ñ po wypieku' }}</li>
        </ul>

        <!-- TIMELINE DOSTAWY -->
        {%- assign now_s = 'now' | date: '%s' | plus: 0 -%}
        {%- assign day = 86400 -%}
        {%- assign dow = 'now' | date: '%w' | plus: 0 -%}

        {%- case dow -%}
          {%- when 1 -%}{%- assign ship_offset = 2 -%}{%- assign deliv_offset = 3 -%}
          {%- when 2 -%}{%- assign ship_offset = 2 -%}{%- assign deliv_offset = 3 -%}
          {%- when 3 -%}{%- assign ship_offset = 2 -%}{%- assign deliv_offset = 5 -%}
          {%- when 4 -%}{%- assign ship_offset = 4 -%}{%- assign deliv_offset = 5 -%}
          {%- when 5 -%}{%- assign ship_offset = 4 -%}{%- assign deliv_offset = 5 -%}
          {%- when 6 -%}{%- assign ship_offset = 3 -%}{%- assign deliv_offset = 4 -%}
          {%- when 0 -%}{%- assign ship_offset = 2 -%}{%- assign deliv_offset = 3 -%}
        {%- endcase -%}

        {%- assign ship_s = ship_offset | times: day | plus: now_s -%}
        {%- assign deliv_s = deliv_offset | times: day | plus: now_s -%}

        <div class="anaj-timeline anaj-card">
          <div class="anaj-tl__header">
            <span class="anaj-tl__eyebrow">Kiedy otrzymasz zam√≥wienie?</span>
            <p class="anaj-tl__hint">Standardowo do 3 dni roboczych.</p>
          </div>

          <div class="anaj-tl">
            <div class="anaj-tl__line" aria-hidden="true"></div>

            <div class="anaj-tl__step">
              <div class="anaj-tl__dot" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="1.8">
                  <circle cx="9" cy="19" r="1.5"></circle>
                  <circle cx="16" cy="19" r="1.5"></circle>
                  <path d="M3 5h2l2.2 9.5a2 2 0 0 0 2 1.5h7.3a2 2 0 0 0 1.9-1.4L20 9H8"></path>
                  <path d="M10 5l1.2-2h3.6L16 5"></path>
                </svg>
              </div>
              <div class="anaj-tl__meta">
                <div class="anaj-tl__date">{{ now_s | date: "%d.%m" }}</div>
                <div class="anaj-tl__label">Zam√≥wienie</div>
              </div>
            </div>

            <div class="anaj-tl__step">
              <div class="anaj-tl__dot" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="1.8">
                  <rect x="3" y="6" width="11" height="8" rx="1.5"></rect>
                  <path d="M14 9h4l3 4v1h-1.5"></path>
                  <circle cx="7" cy="18" r="1.6"></circle>
                  <circle cx="17" cy="18" r="1.6"></circle>
                </svg>
              </div>
              <div class="anaj-tl__meta">
                <div class="anaj-tl__date">{{ ship_s | date: "%d.%m" }}</div>
                <div class="anaj-tl__label">Wypiek &amp; wysy≈Çka</div>
              </div>
            </div>

            <div class="anaj-tl__step">
              <div class="anaj-tl__dot" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="1.8">
                  <rect x="4" y="9" width="16" height="11" rx="1.5"></rect>
                  <path d="M4 12h16M12 9v11"></path>
                  <path d="M8.5 9V6a2 2 0 0 1 4 0v3M15.5 9V6a2 2 0 0 0-4 0"></path>
                </svg>
              </div>
              <div class="anaj-tl__meta">
                <div class="anaj-tl__date">{{ deliv_s | date: "%d.%m" }}</div>
                <div class="anaj-tl__label">Dostawa</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SZCZEG√ì≈ÅY DOSTAWY + BANER -->
        <div class="anaj-extra anaj-extra--right">
          <details class="anaj-acc__item anaj-card anaj-acc--shipping">
            <summary>Szczeg√≥≈Çy dostawy</summary>
            <div class="anaj-acc__content">
              <p>
                üïí <strong>Zam√≥wienia z≈Ço≈ºone do godziny {{ cutoff }}:00</strong><br>
                sƒÖ przygotowywane <strong>nastƒôpnego dnia roboczego</strong>
                (od poniedzia≈Çku do czwartku) i <strong>wysy≈Çane po wypieku oraz sch≈Çodzeniu</strong>.<br>
                <em>Dostawa nastƒôpuje dzie≈Ñ roboczy po wypieku</em>.
              </p>
              <p>
                üì¶ <strong>Zam√≥wienia z≈Ço≈ºone po {{ cutoff }}:00</strong>
                przechodzƒÖ do realizacji w kolejnej turze.
              </p>
              <p>üö´ W piƒÖtki, weekendy i ≈õwiƒôta nie wysy≈Çamy paczek.</p>
            </div>
          </details>

          <div class="anaj-card anaj-banner">
            {% if section.settings.banner_image != blank %}
              <img
                src="{{ section.settings.banner_image | image_url: width: 1200 }}"
                alt="{{ section.settings.banner_alt | default: 'P≈Çatno≈õci i dostawa' }}"
                loading="lazy"
              >
            {% else %}
              <div class="anaj-banner__placeholder">
                Dodaj grafikƒô p≈Çatno≈õci (Blik / InPost / Visa / Mastercard) w ustawieniach sekcji.
              </div>
            {% endif %}
          </div>
        </div>

        <!-- AKORDEONY DLA MOBILE -->
        <div class="anaj-extra anaj-extra--mobile">
          <!-- KOPIA AKORDEON√ìW DLA MOBILE -->
          <details class="anaj-acc__item anaj-card anaj-acc--about">
            <summary>O produkcie</summary>
            <div class="anaj-acc__content">
              {{ product.description | default: 'Brak dodatkowego opisu produktu.' }}
            </div>
          </details>

          {% if ingredients or allergens %}
            <details class="anaj-acc__item anaj-card anaj-acc--ingredients">
              <summary>Sk≈Çad i alergeny</summary>
              <div class="anaj-acc__content">
                {% if ingredients %}
                  <p>
                    <strong>Sk≈Çad</strong> ‚Äî {{ ingredients | escape | newline_to_br }}
                  </p>
                {% endif %}

                {% if allergens %}
                  <p>
                    <strong>Alergeny:</strong>
                    {% if allergens.value %}
                      {{ allergens.value | join: ', ' }}
                    {% else %}
                      {{ allergens }}
                    {% endif %}
                  </p>
                {% endif %}
              </div>
            </details>
          {% endif %}

          <details class="anaj-acc__item anaj-card anaj-acc--nutrition">
            <summary>Warto≈õci od≈ºywcze (na 100 g)</summary>
            <div class="anaj-acc__content">
              {% if nutrition %}
                {{ nutrition }}
              {% else %}
                <div class="anaj-nutri">
                  <div class="anaj-nutri__row">
                    <span>Warto≈õƒá energetyczna</span><strong>411,31 kcal ‚Ä¢ 1719,88 kJ</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>T≈Çuszcz</span><strong>22,5 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî kwasy t≈Çuszczowe nasycone</span><strong>6,1 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî kwasy t≈Çuszczowe nienasycone</span><strong>14,22 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Bia≈Çko</span><strong>7,78 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Woda</span><strong>24,24 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Wƒôglowodany og√≥≈Çem</span><strong>44,31 g</strong>
                  </div>
                  <div class="anaj-nutri__sub">
                    <span>‚Äî w tym cukry</span><strong>21,13 g</strong>
                  </div>
                  <div class="anaj-nutri__row">
                    <span>Chlorek sodu</span><strong>0,16 g</strong>
                  </div>
                  <p class="anaj-nutri__foot">
                    Warto≈õci wg bada≈Ñ laboratorium Nuscana (na 100 g produktu gotowego).
                  </p>
                </div>
              {% endif %}
            </div>
          </details>

          <details class="anaj-acc__item anaj-card anaj-acc--storage">
            <summary>Przechowywanie i ≈õwie≈ºo≈õƒá</summary>
            <div class="anaj-acc__content">
              <p>{{ storage }}</p>
              <p><strong>Termin przydatno≈õci:</strong> {{ shelf }}</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <script type="application/json" id="{{ ROOT }}-vmap">
  [
    {% for v in variants %}
      {
        "id": {{ v.id }},
        "available": {{ v.available | json }},
        "price_cents": {{ v.price | json }},
        "compare_cents": {{ v.compare_at_price | default: 0 | json }},
        "opt1": {{ v.option1 | json }},
        "opt2": {{ v.option2 | json }},
        "opt3": {{ v.option3 | json }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  </script>

  <style>
    /* ... (wszystkie style pozostajƒÖ bez zmian) ... */
  </style>

  <script>
    // ... (wszystkie skrypty pozostajƒÖ bez zmian) ...
  </script>
{%- endif -%}

{% schema %}
{
  "name": "ANAJ ‚Äì strona produktu",
  "tag": "section", 
  "class": "anaj-pdp-section",
  "settings": [
    {
      "type": "text",
      "id": "pill_label",
      "label": "Badge nad tytu≈Çem",
      "default": "Rzemie≈õlniczy wypiek"
    },
    {
      "type": "text", 
      "id": "usp_1",
      "label": "USP #1",
      "default": "≈öwie≈ºo wypiekane na zam√≥wienie"
    },
    {
      "type": "text",
      "id": "usp_2", 
      "label": "USP #2",
      "default": "Dostawa dzie≈Ñ po wypieku"
    },
    {
      "type": "image_picker",
      "id": "banner_image",
      "label": "Baner p≈Çatno≈õci/dostawa"
    },
    {
      "type": "text",
      "id": "banner_alt",
      "label": "Tekst ALT dla banera", 
      "default": "P≈Çatno≈õci i dostawa"
    },
    {
      "type": "textarea",
      "id": "acc_ingredients",
      "label": "Sk≈Çad ‚Äì tre≈õƒá w akordeonie"
    },
    {
      "type": "textarea",
      "id": "acc_allergens",
      "label": "Alergeny ‚Äì tre≈õƒá w akordeonie"
    },
    {
      "type": "richtext", 
      "id": "acc_nutrition",
      "label": "Warto≈õci od≈ºywcze (na 100 g)"
    },
    {
      "type": "textarea",
      "id": "acc_storage",
      "label": "Przechowywanie i ≈õwie≈ºo≈õƒá"
    },
    {
      "type": "text",
      "id": "acc_shelf",
      "label": "Termin przydatno≈õci"
    }
  ],
  "presets": [
    {
      "name": "ANAJ ‚Äì strona produktu",
      "category": "Produkty"
    }
  ]
}
{% endschema %}